#' @title Process and Summarize mdS2G Results
#'
#' @description This function integrates results from colocalization (Coloc), locus-based linking (cS2G), and similarity-based linking (PoPS).
#' It identifies "Credible Genes" supported by multiple lines of evidence (e.g., PoPS + Coloc, or cS2G + Coloc) and formats the final outputs.
#'
#' @param coloc_result Character string. File path to the colocalization results.
#'    This specifically refers to the **"coloc.csv"** file generated by the \code{eqtl_coloc} function.
#' @param SNP_data_create_above Character string. File path to the SNP mapping data.
#'   This specifically refers to the **"SNP_data_for_coloc.csv"** file generated by the \code{nominated_gene_extract} function.
#' @param cs2g_cred_data Character string. File path to the high-confidence cS2G results.
#'   This specifically refers to the **"cs2g_cred_gene.csv"** file generated by the \code{nominated_gene_extract} function.
#' @param save_folder Character string. Directory path to save the processed outputs.
#'
#' @return Outputs several CSV and TXT files to `save_folder`.
#' @export
#' @importFrom data.table fread fwrite
#' @importFrom dplyr %>% select filter mutate group_by summarise ungroup distinct left_join rename_with row_number n
#' @importFrom tidyr pivot_wider pivot_longer separate replace_na
#' @importFrom stringr str_count str_replace_all str_extract
#' @importFrom rlang abort inform
result_process <- function(coloc_result, SNP_data_create_above, cs2g_cred_data, save_folder) {

  # --- 1. Input Validation ---

  validate_file <- function(path, name, expected_cols = NULL) {
    if (missing(path) || !is.character(path) || length(path) != 1 || !file.exists(path)) {
      rlang::abort(paste0("'", name, "' must be a valid file path."))
    }
    df <- data.table::fread(path, stringsAsFactors = FALSE, data.table = FALSE)
    if (!is.null(expected_cols)) {
      missing <- setdiff(expected_cols, colnames(df))
      if (length(missing) > 0) {
        rlang::abort(paste0("File '", name, "' is missing columns: ", paste(missing, collapse = ", ")))
      }
    }
    return(df)
  }

  # Load Data
  coloc_df <- validate_file(coloc_result, "coloc_result",
                            c("nsnps", "PP.H4.abf", "PHENO", "SNP", "GENE", "TISSUE"))

  SNP_data <- validate_file(SNP_data_create_above, "SNP_data_create_above",
                            c("SNP", "PHENO", "GENE1", "GENE6"))

  cs2g_cred <- validate_file(cs2g_cred_data, "cs2g_cred_data",
                             c("SNP", "SYMBOL", "ENSGID", "PHENO"))

  # Check Folder
  if (missing(save_folder) || !is.character(save_folder) || length(save_folder) != 1) {
    rlang::abort("'save_folder' must be a valid path string.")
  }
  if (!dir.exists(save_folder)) dir.create(save_folder, recursive = TRUE)
  if (file.access(save_folder, 2) != 0) rlang::abort("No write permission for 'save_folder'.")
  save_folder <- normalizePath(save_folder)

  rlang::inform("i Inputs validated. Starting processing...")

  # --- 2. Process Colocalization Results ---

  # Logic: Summarize Tissues per SNP-Gene pair, then pivot genes wide
  coloc_df$PHENOSNP <- paste0(coloc_df$PHENO, "-", coloc_df$SNP)

  coloc_wide <- coloc_df %>%
    dplyr::group_by(PHENOSNP, GENE) %>%
    dplyr::summarise(TISSUE = paste(unique(TISSUE), collapse = ","), .groups = 'drop') %>%
    dplyr::group_by(PHENOSNP) %>%
    dplyr::mutate(row_id = dplyr::row_number()) %>%
    dplyr::ungroup() %>%
    tidyr::pivot_wider(
      names_from = row_id,
      values_from = c(GENE, TISSUE),
      names_sep = "_"
    ) %>%
    dplyr::ungroup() %>%
    tidyr::separate(PHENOSNP, into = c("PHENO", "SNP"), sep = "-", remove = FALSE) %>%
    dplyr::rename_with(~ sub("^TISSUE_", "COLOC_TISSUE_", .), dplyr::starts_with("TISSUE_")) %>%
    dplyr::rename_with(~ sub("^GENE_", "COLOC_GENE_", .), dplyr::starts_with("GENE_"))

  # Calculate Statistics
  n_unique_pairs <- nrow(unique(coloc_df[, c("PHENO", "SNP", "GENE")]))

  avg_tissues <- coloc_df %>%
    dplyr::group_by(PHENO, SNP, GENE) %>%
    dplyr::summarise(n_tissues = dplyr::n_distinct(TISSUE), .groups = "drop") %>%
    dplyr::pull(n_tissues) %>%
    mean()

  # Output Metadata & Processed Coloc
  meta_txt <- c(
    paste0("Total number of SNP-GENE-PHENO pairs with colocalization evidence: ", n_unique_pairs),
    paste0("Average number of tissues supporting each colocalization pair: ", round(avg_tissues, 2))
  )
  writeLines(meta_txt, file.path(save_folder, "coloc_metadata.txt"))
  data.table::fwrite(coloc_wide, file.path(save_folder, "coloc_result_processed.csv"))

  rlang::inform(paste0("v Coloc processed. ", n_unique_pairs, " pairs identified."))

  # --- 3. Integrate Evidence (PoPS + cS2G + Coloc) ---

  # 3.1 Prepare SNP Data (PoPS/cS2G)
  # Rename columns to standardized "Source_Gene" format for pivoting
  SNP_data <- SNP_data %>%
    dplyr::rename_with(~ stringr::str_replace_all(., "^GENE([1-5])$", "POPS_GENE_\\1")) %>%
    dplyr::rename_with(~ stringr::str_replace(., "^GENE6$", "cS2G_GENE")) %>%
    dplyr::mutate(PHENOSNP = paste0(PHENO, "-", SNP))

  # 3.2 Merge SNP Mapping with Coloc Results
  # Keep all SNPs from mapping, attach coloc info where available
  merged_wide <- SNP_data %>%
    dplyr::left_join(
      coloc_wide %>% dplyr::select(PHENOSNP, dplyr::starts_with("COLOC_GENE"), dplyr::starts_with("COLOC_TISSUE")),
      by = "PHENOSNP"
    ) %>%
    # Replace NAs with "NONE" for consistent handling
    dplyr::mutate(dplyr::across(dplyr::starts_with("COLOC_"), ~ tidyr::replace_na(., "NONE")))

  # 3.3 Vectorized Evidence Counting (The Optimization)
  rlang::inform("i Analyzing multi-evidence support...")

  # Convert to Long format to handle variable number of columns easily
  long_evidence <- merged_wide %>%
    dplyr::select(PHENOSNP, PHENO, SNP, dplyr::starts_with("POPS_GENE"), dplyr::starts_with("cS2G_GENE"), dplyr::starts_with("COLOC_GENE")) %>%
    tidyr::pivot_longer(
      cols = c(dplyr::starts_with("POPS"), dplyr::starts_with("cS2G"), dplyr::starts_with("COLOC")),
      names_to = "Source_Col",
      values_to = "Gene"
    ) %>%
    dplyr::filter(Gene != "NONE" & !is.na(Gene) & Gene != "") %>%
    # Standardize Source Name
    dplyr::mutate(Source_Type = dplyr::case_when(
      grepl("POPS", Source_Col) ~ "PoPS",
      grepl("cS2G", Source_Col) ~ "cS2G",
      grepl("COLOC", Source_Col) ~ "coloc"
    ))

  # Group by SNP-Gene and Count Evidence Sources
  gene_support <- long_evidence %>%
    dplyr::group_by(PHENOSNP, PHENO, SNP, Gene) %>%
    dplyr::summarise(
      n_evidence = dplyr::n(), # Count occurrences
      Evidence_Str = paste(unique(Source_Type), collapse = ","),
      .groups = "drop"
    ) %>%
    dplyr::filter(n_evidence >= 2) # FILTER: Must be supported by at least 2 entries (e.g. PoPS + Coloc)

  # If no multi-evidence genes found, handle gracefully
  if (nrow(gene_support) == 0) {
    rlang::warn("No genes found with multiple lines of evidence (n >= 2). Outputs will be empty.")
    data_muti_envi <- data.frame(PHENO=character(), SNP=character(), CREDIBLE_GENE_1=character())
  } else {
    # 3.4 Pivot Back to Wide Format for Output
    # We want: PHENO, SNP, CREDIBLE_GENE_1, EVIDENCE_GENE_1, ...
    data_muti_envi <- gene_support %>%
      dplyr::group_by(PHENOSNP) %>%
      dplyr::mutate(rank = dplyr::row_number()) %>%
      dplyr::ungroup() %>%
      tidyr::pivot_wider(
        id_cols = c(PHENOSNP, PHENO, SNP), # Keep identifiers
        names_from = rank,
        values_from = c(Gene, Evidence_Str),
        names_glue = "{.value}_{rank}" # Creates Gene_1, Evidence_Str_1...
      ) %>%
      dplyr::rename_with(~ sub("^Gene_", "CREDIBLE_GENE_", .)) %>%
      dplyr::rename_with(~ sub("^Evidence_Str_", "EVIDENCE_GENE_", .))

    # Restore original column order (PHENO, CHR, SNP, BP) - Join back metadata
    # (Optional: If strict column order needed, fetch CHR/BP from SNP_data)
    meta_cols <- SNP_data %>% dplyr::select(PHENOSNP, CHR, BP) %>% dplyr::distinct()
    data_muti_envi <- data_muti_envi %>%
      dplyr::left_join(meta_cols, by = "PHENOSNP") %>%
      dplyr::select(PHENO, CHR, SNP, BP, dplyr::everything(), -PHENOSNP)
  }

  data.table::fwrite(data_muti_envi, file.path(save_folder, "credible_gene_muti_evidence.csv"))

  # --- 4. Merge High-Confidence cS2G ---

  # Prepare High-Confidence Data
  cs2g_high <- cs2g_cred %>%
    dplyr::rename(CREDIBLE_GENE_highConfi = ENSGID) %>%
    dplyr::mutate(
      EVIDENCE_GENE_highConfi = "cS2G(confi>=0.8)",
      PHENOSNP = paste0(PHENO, "-", SNP)
    ) %>%
    dplyr::select(PHENOSNP, CREDIBLE_GENE_highConfi, EVIDENCE_GENE_highConfi)

  # Join with Multi-Evidence Data
  # We need PHENOSNP back in data_muti_envi if we removed it, let's reconstruct or keep it
  if (!"PHENOSNP" %in% colnames(data_muti_envi)) {
    data_muti_envi$PHENOSNP <- paste0(data_muti_envi$PHENO, "-", data_muti_envi$SNP)
  }

  final_merged <- data_muti_envi %>%
    dplyr::left_join(cs2g_high, by = "PHENOSNP") %>%
    dplyr::select(-PHENOSNP) # Clean up

  data.table::fwrite(final_merged, file.path(save_folder, "CredibleGene_all.csv"))

  rlang::inform("v Credible genes integrated.")

  # --- 5. Generate Unique Gene List (Matrix Format) ---

  # Extract all credible genes (both multi-evidence and high-conf cS2G)
  long_genes <- final_merged %>%
    dplyr::select(PHENO, dplyr::starts_with("CREDIBLE_GENE")) %>%
    tidyr::pivot_longer(
      cols = dplyr::starts_with("CREDIBLE_GENE"),
      values_to = "Gene",
      values_drop_na = TRUE
    ) %>%
    dplyr::filter(Gene != "" & Gene != "NONE") %>%
    dplyr::distinct(PHENO, Gene)

  # Reshape into List-like Matrix (Columns = Phenos)
  phenotypes <- unique(long_genes$PHENO)

  if (length(phenotypes) > 0) {
    # Create list of genes per phenotype
    pheno_gene_list <- split(long_genes$Gene, long_genes$PHENO)

    # Find max length to pad with NA
    max_len <- max(sapply(pheno_gene_list, length))

    # Construct data frame
    unique_gene_df <- do.call(cbind, lapply(phenotypes, function(p) {
      g <- pheno_gene_list[[p]]
      length(g) <- max_len # Pad with NA
      return(g)
    }))
    colnames(unique_gene_df) <- phenotypes
    unique_gene_df <- as.data.frame(unique_gene_df)

    data.table::fwrite(unique_gene_df, file.path(save_folder, "unique_CredibleGene.csv"))
  } else {
    rlang::warn("No credible genes found across any phenotype.")
  }

  data.table::fwrite(cs2g_cred, file.path(save_folder, "cs2g_cred_gene.csv"))

  rlang::inform(paste0("All tasks completed. Results saved to: ", save_folder))
}
